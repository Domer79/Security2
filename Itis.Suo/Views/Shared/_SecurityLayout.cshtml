@using System.Web.Optimization

@{
    Layout = null;
}

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Angular Material style sheet -->
    <script src="~/scripts/itisExports.js" type="text/javascript"></script>

    <title>Настройка безопасности</title>

</head>
<body ng-app="SecurityApp">
    <div>
        @RenderBody()
    </div>

    @Styles.Render("~/styles/angular-material")
    @Scripts.Render("~/scripts/angular-material-package")
    @Scripts.Render("~/scripts/angular-ui-router")
    @Scripts.Render("~/scripts/security")

    <script type="text/javascript">
        "use strict";
        var securityApp = angular.module("SecurityApp", ['ngMaterial', 'ui.router']);

        securityApp.config(function ($stateProvider, $mdIconProvider) {
            $mdIconProvider.iconSet('navigation', '/Content/images/material-icons/iconsets/navigation-icons.svg');

            var states = [
                {
                    name: 'adminpanel',
                    url: '/adminpanel',
                    abstract: true,
                    views: {
                        "main": {
                            component: "adminpanel"
                        }
                    },
                    data: {
                        tabs2: {
                            0: "tab0",
                            1: "tab1",
                            2: "tab2"
                        }
                    }
                },
                {
                    name: 'users',
                    parent: 'adminpanel',
                    url: '/users',
                    views: {
                        "users": {
                            component: 'users'
                        }
                    },
                    resolve: {
                        users: function (UserProvider) {
                            var allUsers = UserProvider.getAllUsers();
                            return allUsers;
                        }
                    },
                    params: { login: null }
                },
                {
                    name: 'detail',
                    parent: 'users',
                    url: '/{login}',
                    params: {login: null},
                    views: {
                        "tab0@adminpanel": {
                            component: 'userProfile'
                        },
                        "tab1@adminpanel": {
                            component: "groupProfile"
                        },
                        "tab2@adminpanel": {
                            component: "roleProfile"
                        }
                    },
                    resolve: {
                        user: function (users, $stateParams) {
                            return users.find(function(user) {
                                return user.Login === $stateParams.login;
                            });
                        },
                        groups: function ($stateParams, GroupProvider) {
                            var allGroupsByUser = GroupProvider.getAllGroupsByUser($stateParams.login);
                            return allGroupsByUser;
                        },
                        roles: function($stateParams, RoleProvider) {
                            var roles = RoleProvider.getRolesByUser($stateParams.login);
                            return roles;
                        },
                        userInfoCollection: function(users, $stateParams) {
                            function link(key, value) {
                                this.key = key;
                                this.value = value;
                            }

                            var linkCollection = [];

                            var user = users.find(function (user) {
                                return user.Login === $stateParams.login;
                            });

                            if (user == null)
                                user.info = `User ${$stateParams.login} is not found`;

                            var keys = Object.getOwnPropertyNames(user);
                            for (var i = 0; i < keys.length; i++) {
                                linkCollection.push(new link(keys[i], user[keys[i]]));
                            }

                            return linkCollection;
                        }
                    }
                }
            ];

            states.forEach(function (state) {
                $stateProvider.state(state);
            });
        });

        itisExports.controllers.register(securityApp);
        itisExports.components.register(securityApp);
        itisExports.providers.register(securityApp);

        securityApp.run(function ($state) {
            $state.go('users');
        });

    </script>

    @RenderSection("angularscript", false)

</body>
</html>
