1 Общие положения   
1.1 Назначение документа    
Данный документ предназначен для разработчиков, которые собираются использовать в своих приложениях механизмы ограничения к ресурсам своих приложений и аутентификации поль-зователей и описывает основные программные механизмы СУД.
1.2 Термины сокращения и определения    
Термин | Определение
------|------
СУД	| Система управления доступом 
Объект безопасности |	это пользователь или группа пользователей, на которых накладываются роли (безопасности). Один пользователь может входить в несколько групп, одна группа может иметь несколько пользователей. Один участник безопас-ности может иметь несколько ролей, также как роль может предоставляться нескольким участникам безопасности.
Тип доступа |	это составляющая политик безопасности. Является статичной информацией, определяющейся во время проектирования ПО. Предназначена для настройки политик без-опасности на низком уровне. Например, операции извлечения, добавления, редактирования, удаления данных из БД
Роль |	это сопоставление, с одной стороны множества прав доступа (политик безопасности), необходимых для выполнения конкретных функций, а с другой стороны — подмножества пользователей, которые должны иметь эти права
Разрешение |	это определение политики безопасности, т.е. назначение определенного типа доступа для объекта безопасности и предоставление этой политики безопасности для роли

2 Введение
Система управления доступом (СУД) является сервисом, предоставляющим подключенным к нему приложениям информацию о том, разрешен ли доступ к ресурсу для пользователя. 
2 Общее описание работы информационных потоков
2.1 Описание структуры компонентов
1.	База данных
2.	Ядро системы (Security)
3.	Компонент, описывающий интерфейсы взаимодействия системы (Security.Interfaces)
4.	Компонент доступа к данным (Security.EntityDal)
5.	Компонент описывающий модель данных (Security.Model)
6.	Драйвер, для управления данными ядра системы (Security.EntityFramework)
7.	Расширение для веб-приложений (Security.Web)
8.	Система настройки прав доступа (Веб-приложение)
Схема взаимодействия компонентов представлена на Рисунок 1 Структура компонентов. Как видно из рисунка система представляет собой многоуровневый подход взаимодействия ком-понентов. Описание компонентов представлено ниже.

2.1.1 База данных
Основным компонентом системы в целом является база данных, в которой заложена ос-новная концептуальная логика системы, такие как ограничения целостности, уникальные индексы, триггеры, обеспечивающие целостность отдельных сущностей, хранимые процедуры, скалярные функции и т.п. Представляет собой низкоуровневую реализацию системы
2.1.2 Ядро системы
CoreSecurity, реализующий интерфейс ISecurity Реализует основную программную логику API СУД: 
Класс CoreSecurity.



Таблица 1     
Класс | Описание     
-------|---------:    
IUserCollection UserCollection	| Коллекция пользователей     
IGroupCollection GroupCollection	|Коллекция групп пользователей
ISecObjectCollection SecObjectCollection|	Коллекция объектов безопасности для текущего приложения
IRoleCollection RoleCollection |	Коллекция ролей для текущего при-ложения
IMemberCollection MemberCollection	| Коллекция участников безопасности – пользователи и группы.
IGrantCollection GrantCollection |	Коллекция разрешений для текущего приложения
IApplicationCollection ApplicationCollection |	Коллекция приложений
ISecurityTools Tools |	Дополнительные инструменты работы с данными
ISecuritySettings Settings |	Коллекция и инструментарий работы с настройками
IApplication CurrentApplication |	Текущее приложение.
bool LogIn(string login, string password) |	Проверка входа по логину и паролю
bool CheckAccess(string login, string secObjectName, Enum accessType); |	Проверка доступа пользователя к объекту безопасности по определен-ному типу доступа
bool CheckAccess(string login, string secObjectName, Enum accessType, string appName); |	Проверка доступа пользователя к объекту безопасности по определен-ному типу доступа, с указанием при-ложения, для которого применяется проверка доступа
bool CheckAccess(string login, string secObjectName, string accessTypeName); |	Проверка доступа пользователя к объекту безопасности по определен-ному типу доступа
bool CheckAccess(string login, string secObjectName, string accessTypeName, string appName); |	Проверка доступа пользователя к объекту безопасности по определен-ному типу доступа, с указанием при-ложения, для которого применяется проверка доступа
IEnumerable<string> GetAllowAllSecurityObjects(string accessType); |	Возвращает все объекты безопасно-сти для указанного типа доступа и те-кущего приложения
IEnumerable<string> GetAllowSecurityObjects(string login, string accessType) |		Возвращает все доступные для поль-зователя объекты безопасности для указанного типа доступа и текущего приложения
ISecurityTransaction BeginTransaction() |	Создает новую транзакцию для рабо-ты с БД
IEnumerable<IAccessType> GetAccessTypes() |	Возвращает коллекцию типов доступа для текущего приложения
int SaveChanges(); |	Производит сохранение всех измене-ний в настройках системы безопасно-сти. Возвращает количество затронутых строк.
Task<int> SaveChangesAsync(); |	Производит асинхронное сохранение всех изменений в настройках системы безопасности.

Класс Config, предназначен для регистрации сборки, к которой будет применен механизм ограничения доступа.   
2.1.3. Компонент, описывающий интерфейсы взаимодействия системы     
Представляет собой уровень абстракций и предназначен для взаимодействия компонентов между собой.    
2.1.4. Компонент доступа к данным   
Предназначен для непосредственного взаимодействия с данными и используется непо-средственно только драйвером. В качестве ORM используется EntityFramework 6.1.3.      
2.1.5. Компонент описывающий модель данных  
В данном компоненте описаны классы в совокупности, представляющие собой модель ба-зы данных.    
2.1.6. Драйвер, для управления данными ядра системы 
Промежуточный компонент, который предназначен для взаимодействия ядра с низкоуров-невым API системы. Этот компонент, по сути, нужен лишь для реализации интерфейса ISecurityFactory, который является фабрикой методов для ядра системы.    
2.1.7. Расширение для веб-приложений    
Является одним из частных случаев применения API системы доступа, в котором реализо-ваны некоторые классы и механизмы, облегчающие использование СУД в приложениях.     
2.1.8. Система настройки прав доступа   
Это web-приложение, которое позволяет настраивать доступ к ресурсам зарегистрирован-ных в СУД приложений. Настройка прав доступа описано в «Руководстве пользователя». Также, в этом компоненте определен по умолчанию тип доступа “Exec”.  
2.2. Описание работы системы    
2.2.1. Как подключить   
Первоначально, чтобы подключить СУД в свое приложение, необходимо установить для сборки атрибут AssemblySecurityApplicationInfoAttribute, заполнив в его конструкторе пара-метры applicationName и description. Это нужно для того, чтобы можно было создавать экзем-пляр класса CoreSecurity конструктором по умолчанию. В этом случае конструктор ищет атри-бут в сборке, из которой осуществляется вызов и, если не находит вызывает исключение. Далее, на этапе загрузки приложения необходимо зарегистрировать специальный модуль, инициализиру-ющий фабрику ISecurityFactory и зарегистрировать приложение, как в следующем примере:
```
        public static void RegisterSecurity()
        {
            Config.RegisterCommonModule<CommonModule>();
            Config.RegisterApplication(new ExecSecurityObjects(new []{Assembly.GetExecutingAssembly()}));
        }
```
в примере выше методу Config.RegisterApplication дополнительно передается список объектов безопасности, который определяется в вызывающей сборке (Assembly.GetExecutingAssembly()). Метод Config.RegisterApplication имеет несколько перегрузок, которые позволяют передавать дополнительные параметры: типы доступа, сборку, к которой необходимо применить модель без-опасности. При регистрации приложения, система проверяет наличие в базе данных информации о приложении, типах доступа и определенных в сборке объектах безопасности и в случае их отсут-ствия производить запись. После регистрации, приложение его типы доступа и объекты безопас-ности станут доступными в системе настройки прав доступа.    
В процессе регистрации конфигуратор, помимо остальных типов доступа, которые были переданы в метод, по умолчанию регистрирует еще один тип доступа “Exec”, который необходимо использовать для проверки доступа на исполняемые ресурсы, например, методы и функции при-ложения или для проверки доступа к контроллерам Mvc или их действиям в web-приложениях, об этом будет описано ниже.  
В системе администрирования при установке разрешения для ролей отображаются только те объекты безопасности, которые были определены для типа доступа “Exec”. Для всех остальных типов доступа обработку разрешения на доступ к ресурсам следует делать в своих приложениях самостоятельно.      
Чтобы определить список объектов безопасности необходимо реализовать интерфейс ISecurityObjects, и передать экземпляр этого интерфейса в метод конфигуратора Config.RegisterApplication, при этом список объектов безопасности сохраняется в базе данных СУД. Такой метод добавления объектов безопасности подходит только для статичной информа-ции. Чтобы можно было добавлять объекты безопасности динамически в ходе работы приложе-ния, можно воспользоваться одним из перегруженных методов Add или AddRange интерфейса ISecObjectCollection через свойство SecObjectCollection класса CoreSecurity.  
Пример создания списка типа доступа через тип Enum:
```
    public enum EAccessType
    {
        Exec,
        Read
    }
```
при этом, передавая тип Enum в метод Config.RegisterApplication все значения перечислений это-го типа будут преобразованы в строку и таким образом зафиксированы в БД.  
2.2.2 Как использовать  
Далее, чтобы в сборке, которая была зарегистрирована в системе осуществить проверку доступа к какому-либо из объектов безопасности нужно вызвать один из перегруженных методов CheckAccess класса CoreSecurity, указав логин, выполнившего вход пользователя, наименование объекта безопасности в формате строки и тип доступа в формате строки или перечислителем (тип Enum). Пример:
```
var allow = security.CheckAccess(login, “SecurityObject_Name”, “Exec”);
или 
var allow = security.CheckAccess(login, “SecurityObject_Name”, EAccessType.Exec);
```
где EAccessType – это перечислитель (Enum). 
2.2.3 Web-расширение (Security.Web)     
В данном разделе будет описан компонент предназначенный только для использования в web-приложениях. При желании такого рода расширений можно сделать для разных типов прило-жений. Компонент работает с заранее определенным типом доступа “Exec”. Компонент состоит из нескольких модулей:
1.	Модуль идентификации пользователя (SecurityAuthenticateHttpModule)
2.	Модуль поиска объектов безопасности (ExecSecurityObjects) в подключаемой сборке атрибутам авторизации (AuthorizeAttribute)
3.	Атрибуты авторизации отдельно для приложений Asp.Net Web API и Asp.Net MVC  
2.2.3.1 SecurityAuthenticateHttpModule  
Модуль SecurityAuthenticateHttpModule служит для идентификации и олицетворения поль-зователя согласно модели системы безопасности. Он срабатывает каждый раз, когда запрашива-ется та или иная страница и если пользователь аутентифицирован, то олицетворяет его беря ин-формацию по нему из базы данных СУД. Для этого в компоненте реализованы интерфейсы IPrincipal и IIdentity в классах UserPrincipal и UserIdentity соответственно.      
Чтобы получить информацию о пользователе можно воспользоваться свойством User класса HttpContext, пример:
```
((UserIdentity)HttpContext.Current.User.Identity)
или
(HttpContext.Current.User.Identity as UserIdentity).
```
Данный модуль необходимо подключить к web-приложению прописав его файле web.config, пример:
```
<system.webServer>
    <modules>
      <remove name="SecurityAuthenticateHttpModule" />
      <add name="SecurityAuthenticateHttpModule" type="Security.Web.SecurityAuthenticateHttpModule, Security.Web, Version=1.0.0.0" />
    </modules>
</system.webServer>
```
предварительно подключив к приложению сборку Security.Web.dll.  
2.2.3.2 ExecSecurityObjects 
Модуль ExecSecurityObjects служит для поиска в подключаемой сборке (web-приложения) контроллеров и их открытых методов, возвращающих экземпляр класса ActionResult и помечен-ных атрибутом, унаследованным от класса AuthorizeAttribute из пространства имен Security.Web.Mvc. Этот класс разработан в помощь разработчику, внедряющему СУД в свое web-приложение, его использование представлено выше.    
2.2.3.3 Атрибуты авторизации из пространства имен Security.Web.Mvc и Security.Web.Http  
Данные атрибуты позволяют ограничить доступ к запрашиваемым страницам. В компоненте Security.Web реализованы два таких атрибута: для приложений ASP.NET MVC и Web API. Унасле-дованы от класса System.Web.Mvc.AuthorizeAttribute и System.Web.Http.AuthorizeAttribute и реали-зующих интерфейс ISecurityObject для регистрации их в СУД. Классы атрибутов являются аб-страктными, поэтому в своих приложениях необходимо использовать свои классы, унаследован-ные от данных атрибутов.     
Для атрибутов, унаследованных от System.Web.Mvc.AuthorizeAttribute необходимо пе-реопределить два абстрактных метода GetNotAllowViewResult() и GetNotAllowAjaxResult(). Пример:
```
    public class SecurityAuthorizeAttribute : Security.Web.Mvc.AuthorizeAttribute
    {
        public SecurityAuthorizeAttribute(string objectName) 
            : base(typeof(SecurityAuthorizeAttribute).Assembly)
        {
            ObjectName = objectName;
        }

        /// <summary>
        /// Возвращает страницу с сообщением об ошибке на обычный http запрос
        /// </summary>
        /// <returns>ActionResult</returns>
        protected override ActionResult GetNotAllowViewResult()
        {
            return new HttpUnauthorizedResult("Access Denied!");
        }

        /// <summary>
        /// Возвращает сообщение об ошибки на AJAX запрос
        /// </summary>
        /// <returns>Сообщение в формате JSON, XML или в любых других форматах</returns>
        protected override ActionResult GetNotAllowAjaxResult()
        {
            return new HttpStatusCodeResult(HttpStatusCode.Forbidden, "Access Denied!");
        }
    }
```
Как видно из примера, оба этих метода срабатывают в том случае, если доступ к ресурсу запрещен. Метод GetNotAllowViewResult() возвращает ответ на обычный http-запрос, а метод GetNotAllowAjaxResult() на AJAX-запрос. Также,для обоих атрибутов необходимо переопределить один из их конструкторов, передав в качестве параметра сборку или наименование приложения. В обоих атрибутах присутствуют свойства, ObjectName и AccessType. Первое свойство определяет наименования объекта безопасности. Из примера выше видно, что оно инициализируется в конструкторе через его параметр.  Свойство AccessType скрыто и ему по умолчанию установлено значение “Exec”.    
Эти атрибуты можно установить, как для всего контроллера, так и для отдельных его дей-ствий. В первом случае все действия контроллера будут зарегистрированы как объекты безопас-ности, во втором только помеченные атрибутом. При установке значения свойству ObjectName оно будет отображено в системе администрирования, иначе в свойство ObjectName будет записа-но значение исходя из следующего алгоритма Controller/Action. Значение свойства ObjectName является ключом для определения разрешения, поэтому изменив его, разрешение на этот объект безопасности необходимо будет переопределить заново. Также к примеру, если несколько запро-сов обрабатывают один функционал приложения целесообразней будет пометить несколько дей-ствий контроллера одним и тем же значением ObjectName.
